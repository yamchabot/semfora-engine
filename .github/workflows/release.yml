name: Release

on:
  push:
    tags:
      - 'v*'

env:
  CARGO_TERM_COLOR: always

permissions:
  contents: write

jobs:
  # Note: Tests are NOT run here - CI workflow must pass before merging to main,
  # and releases are only created from main. Running tests again would be redundant.

  build:
    name: Build (${{ matrix.artifact }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact: linux-x86_64
            ext: tar.gz
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact: darwin-arm64
            ext: tar.gz
          # Cross-compile x86_64 from ARM macOS (macos-13 Intel runners are retired)
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact: darwin-x86_64
            ext: tar.gz
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact: windows-x86_64
            ext: zip

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-release-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.target }}-cargo-release-

      - name: Build release
        run: cargo build --release --target ${{ matrix.target }}
        env:
          # Use clang-cl on Windows to handle GCC-style flags from tree-sitter crates
          CC_x86_64_pc_windows_msvc: ${{ matrix.os == 'windows-latest' && 'clang-cl' || '' }}
          CXX_x86_64_pc_windows_msvc: ${{ matrix.os == 'windows-latest' && 'clang-cl' || '' }}

      - name: Extract version
        id: version
        shell: bash
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Package binaries (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          mkdir -p dist
          cp target/${{ matrix.target }}/release/semfora-engine dist/
          cp target/${{ matrix.target }}/release/semfora-engine-server dist/
          cp target/${{ matrix.target }}/release/semfora-daemon dist/

          ARCHIVE="semfora-engine-${{ steps.version.outputs.version }}-${{ matrix.artifact }}.${{ matrix.ext }}"
          tar -czvf "$ARCHIVE" -C dist .

          # Generate SHA256 checksum
          shasum -a 256 "$ARCHIVE" > "$ARCHIVE.sha256"

          echo "Created: $ARCHIVE"
          cat "$ARCHIVE.sha256"

      - name: Package binaries (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          mkdir dist
          copy target\${{ matrix.target }}\release\semfora-engine.exe dist\
          copy target\${{ matrix.target }}\release\semfora-engine-server.exe dist\
          copy target\${{ matrix.target }}\release\semfora-daemon.exe dist\

          $archive = "semfora-engine-${{ steps.version.outputs.version }}-${{ matrix.artifact }}.${{ matrix.ext }}"
          Compress-Archive -Path dist\* -DestinationPath $archive

          # Generate SHA256 checksum
          $hash = (Get-FileHash -Path $archive -Algorithm SHA256).Hash.ToLower()
          "$hash  $archive" | Out-File -FilePath "$archive.sha256" -Encoding ASCII

          Write-Host "Created: $archive"
          Get-Content "$archive.sha256"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: semfora-engine-${{ matrix.artifact }}
          path: |
            semfora-engine-*.${{ matrix.ext }}
            semfora-engine-*.${{ matrix.ext }}.sha256
          if-no-files-found: error

  release:
    name: Create Release & Upload to R2
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir -p release
          find artifacts -type f \( -name "*.tar.gz" -o -name "*.zip" -o -name "*.sha256" \) -exec cp {} release/ \;

          echo "Release files:"
          ls -la release/

          # Create version.txt for the CDN
          echo "${{ steps.version.outputs.version }}" > release/version.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          prerelease: ${{ contains(github.ref, '-rc') || contains(github.ref, '-beta') || contains(github.ref, '-alpha') }}
          generate_release_notes: true
          files: release/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Upload to Cloudflare R2 for CDN distribution
      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Upload to R2 (versioned)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Upload each file to the versioned directory
          for file in release/*; do
            filename=$(basename "$file")
            echo "Uploading $filename to releases/$VERSION/$filename"
            wrangler r2 object put "semfora-releases/$VERSION/$filename" --file="$file"
          done

      - name: Update latest symlink on R2
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Upload version.txt to latest/
          echo "$VERSION" > latest-version.txt
          wrangler r2 object put "semfora-releases/latest/version.txt" --file="latest-version.txt"

          # Copy all release files to latest/ directory
          for file in release/*.tar.gz release/*.zip release/*.sha256; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              # Remove version from filename for latest/
              # e.g., semfora-engine-1.0.0-linux-x86_64.tar.gz -> semfora-engine-linux-x86_64.tar.gz
              latest_filename=$(echo "$filename" | sed "s/-$VERSION//")
              echo "Uploading to latest/$latest_filename"
              wrangler r2 object put "semfora-releases/latest/$latest_filename" --file="$file"
            fi
          done

      - name: Release Summary
        run: |
          echo "## Release v${{ steps.version.outputs.version }} Published!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Downloads" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Download |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Linux x86_64 | \`curl -fsSL https://dl.semfora.com/releases/${{ steps.version.outputs.version }}/semfora-engine-${{ steps.version.outputs.version }}-linux-x86_64.tar.gz\` |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS ARM64 | \`curl -fsSL https://dl.semfora.com/releases/${{ steps.version.outputs.version }}/semfora-engine-${{ steps.version.outputs.version }}-darwin-arm64.tar.gz\` |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS x86_64 | \`curl -fsSL https://dl.semfora.com/releases/${{ steps.version.outputs.version }}/semfora-engine-${{ steps.version.outputs.version }}-darwin-x86_64.tar.gz\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Windows x86_64 | \`curl -fsSL https://dl.semfora.com/releases/${{ steps.version.outputs.version }}/semfora-engine-${{ steps.version.outputs.version }}-windows-x86_64.zip\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quick Install" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "curl -fsSL https://sh.semfora.com/install.sh | bash" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
